
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Digest</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>
        body { padding: 2rem; }
        #dropzone { border: 2px dashed #ccc; padding: 2rem; text-align: center; cursor: pointer; }
        .severity-high { background-color: #d9534f; color: white; padding: 0.2em 0.6em; border-radius: 0.25em; }
        .severity-medium { background-color: #f0ad4e; color: white; padding: 0.2em 0.6em; border-radius: 0.25em; }
        .severity-low { background-color: #5cb85c; color: white; padding: 0.2em 0.6em; border-radius: 0.25em; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 1rem auto;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback } = React;
        const API_BASE_URL = "/api";

        function App() {
            const [file, setFile] = useState(null);
            const [docType, setDocType] = useState('contract');
            const [status, setStatus] = useState('idle');
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');

            const pollJobStatus = useCallback(async (id) => {
                const response = await fetch(`${API_BASE_URL}/result/${id}`);
                const data = await response.json();
                if (data.status === 'complete') {
                    setStatus('complete');
                    setResult(data.result);
                } else if (data.status === 'failed') {
                    setStatus('error');
                    setError(`Analysis failed: ${data.error}`);
                } else {
                    setTimeout(() => pollJobStatus(id), 2000);
                }
            }, []);

            const handleAnalyze = async () => {
                if (!file) return;
                setStatus('uploading');
                setError('');
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const uploadRes = await fetch(`${API_BASE_URL}/upload`, { method: 'POST', body: formData });
                    if (!uploadRes.ok) throw new Error('File upload failed.');
                    const uploadData = await uploadRes.json();
                    
                    setStatus('processing');
                    const analyzeRes = await fetch(`${API_BASE_URL}/analyze`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_id: uploadData.file_id, doc_type: docType })
                    });
                    if (!analyzeRes.ok) throw new Error('Failed to start analysis.');
                    const analyzeData = await analyzeRes.json();
                    pollJobStatus(analyzeData.job_id);
                } catch (err) {
                    setStatus('error');
                    setError(err.message);
                }
            };

            return (
                <main className="container">
                    <h1>ðŸ“„ Account Digest</h1>
                    {status === 'idle' || status === 'error' ? (
                        <article>
                            <div id="dropzone" onClick={() => document.getElementById('fileInput').click()}>
                                {file ? `Selected: ${file.name}` : 'Drag & drop a PDF here, or click to select'}
                            </div>
                            <input type="file" id="fileInput" accept="application/pdf" style={{ display: 'none' }} onChange={(e) => setFile(e.target.files[0])} />
                            <select value={docType} onChange={(e) => setDocType(e.target.value)}>
                                <option value="contract">Contract</option>
                                <option value="data_report">Data Report</option>
                            </select>
                            <button onClick={handleAnalyze} disabled={!file}>Analyze</button>
                            {error && <p style={{ color: 'red' }}><strong>Error:</strong> {error}</p>}
                        </article>
                    ) : null}

                    {status === 'processing' || status === 'uploading' ? (
                        <article><div className="loader"></div><p style={{textAlign: 'center'}}>Analyzing...</p></article>
                    ) : null}

                    {status === 'complete' && result ? (
                        <article>
                            <h2>Analysis Complete</h2>
                            <h3>Summary</h3>
                            <ul>
                                {result.summary_md.split('-').filter(item => item.trim()).map((bullet, i) => <li key={i}>{bullet.trim()}</li>)}
                                </ul>
                            <h3>Risk Analysis</h3>
                            <table>
                                <thead><tr><th>Risk</th><th>Severity</th><th>Reason</th><th>Page</th></tr></thead>
                                <tbody>
                                    {result.risks.map((risk, i) => (
                                        <tr key={i}>
                                            <td>{risk.title}</td>
                                            <td><span className={`severity-${risk.severity}`}>{risk.severity}</span></td>
                                            <td>{risk.reason}</td>
                                            <td>{risk.page}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </article>
                    ) : null}
                </main>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>
